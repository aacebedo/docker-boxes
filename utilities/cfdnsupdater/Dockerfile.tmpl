FROM {{.Env.BASE_IMAGE}}

RUN apk update
RUN apk add zsh vim ca-certificates wget

ARG CFDNSUPDATER_INSTALLDIR=/opt/cfdnsupdater
ARG CFDNSUPDATER_CONFDIR=/etc

ARG CFDNSUPDATER_VERSION=0.9.2
ARG CFDNSUPDATER_ARCH=amd64
ARG CFDNSUPDATER_URL=https://github.com/aacebedo/cfdnsupdater/releases/download/${CFDNSUPDATER_VERSION}/cfdnsupdater.${CFDNSUPDATER_ARCH}.${CFDNSUPDATER_VERSION}.tar

ARG DOCKERIZE_VERSION=0.2.0
ARG DOCKERIZE_ARCH=amd64
ARG DOCKERIZE_URL=https://github.com/aacebedo/dockerize/releases/download/v${DOCKERIZE_VERSION}/dockerize-linux-${DOCKERIZE_ARCH}-v${DOCKERIZE_VERSION}.tar.gz
ARG DOCKERIZE_INSTALLDIR=/opt/dockerize

ARG CFDNSUPDATER_USER=cfdnsupdater
ARG CFDNSUPDATER_UID=1000
ARG CFDNSUPDATER_GROUP=cfdnsupdater
ARG CFDNSUPDATER_GID=1000

ENV CFDNSUPDATER_DOMAIN=exmaple.com
ENV CFDNSUPDATER_EMAIL=admin@example.com
ENV CFDNSUPDATER_APIKEY=None
ENV CFDNSUPDATER_PERIOD=90
ENV CFDNSUPDATER_RECORDTYPES=""
ENV CFDNSUPDATER_RECORDNAMES=""

RUN addgroup -g ${CFDNSUPDATER_GID} -S ${CFDNSUPDATER_GROUP}
RUN adduser -G ${CFDNSUPDATER_GROUP} -u ${CFDNSUPDATER_UID} -S -H ${CFDNSUPDATER_USER} 

RUN mkdir -p ${DOCKERIZE_INSTALLDIR}
RUN mkdir -p ${CFDNSUPDATER_INSTALLDIR}
RUN mkdir -p ${DOCKERIZE_INSTALLDIR}

RUN wget ${DOCKERIZE_URL} -O /tmp/dockerize.tar.gz
RUN tar -xzvf /tmp/dockerize.tar.gz -C ${DOCKERIZE_INSTALLDIR}
RUN rm /tmp/dockerize.tar.gz

RUN wget ${CFDNSUPDATER_URL} -O /tmp/cfdnsupdater.tar
RUN tar -xvf /tmp/cfdnsupdater.tar -C ${CFDNSUPDATER_INSTALLDIR} 
RUN rm -rf /tmp/cfdnsupdater.tar

COPY ./files/cfdnsupdater.conf.tmpl ${CFDNSUPDATER_INSTALLDIR}/cfdnsupdater.conf.tmpl
COPY files/entrypoint.sh.tmpl ${CFDNSUPDATER_INSTALLDIR}/entrypoint.sh.tmpl
RUN ${DOCKERIZE_INSTALLDIR}/dockerize -template ${CFDNSUPDATER_INSTALLDIR}/entrypoint.sh.tmpl:${CFDNSUPDATER_INSTALLDIR}/entrypoint.sh

RUN chown -R ${CFDNSUPDATER_USER}:${CFDNSUPDATER_GROUP} ${CFDNSUPDATER_INSTALLDIR}
RUN chown -R ${CFDNSUPDATER_USER}:${CFDNSUPDATER_GROUP} ${CFDNSUPDATER_CONFDIR}
RUN chown -R ${CFDNSUPDATER_USER}:${CFDNSUPDATER_GROUP} ${DOCKERIZE_INSTALLDIR}

RUN chmod u+x ${CFDNSUPDATER_INSTALLDIR}/entrypoint.sh

USER ${CFDNSUPDATER_USER}

WORKDIR ${CFDNSUPDATER_INSTALLDIR}

ENTRYPOINT ["./entrypoint.sh"]